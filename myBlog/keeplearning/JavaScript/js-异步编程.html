<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JavaScript异步编程 | will个人主页</title>
    <meta name="description" content="生活不止眼前的苟且还有诗和远方的田野">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="icon" href="/myBlog/logo.png">
    
    <link rel="preload" href="/myBlog/assets/css/0.styles.cc54622c.css" as="style"><link rel="preload" href="/myBlog/assets/js/app.daefb15c.js" as="script"><link rel="preload" href="/myBlog/assets/js/2.97733961.js" as="script"><link rel="preload" href="/myBlog/assets/js/29.8556412b.js" as="script"><link rel="prefetch" href="/myBlog/assets/js/10.59aa41ee.js"><link rel="prefetch" href="/myBlog/assets/js/11.e8999251.js"><link rel="prefetch" href="/myBlog/assets/js/12.0581b4c3.js"><link rel="prefetch" href="/myBlog/assets/js/13.adf220f8.js"><link rel="prefetch" href="/myBlog/assets/js/14.262818f6.js"><link rel="prefetch" href="/myBlog/assets/js/15.649e750b.js"><link rel="prefetch" href="/myBlog/assets/js/16.9c34e705.js"><link rel="prefetch" href="/myBlog/assets/js/17.149c424d.js"><link rel="prefetch" href="/myBlog/assets/js/18.53ef2ecd.js"><link rel="prefetch" href="/myBlog/assets/js/19.84f19774.js"><link rel="prefetch" href="/myBlog/assets/js/20.c4b9af8f.js"><link rel="prefetch" href="/myBlog/assets/js/21.adfabc54.js"><link rel="prefetch" href="/myBlog/assets/js/22.7331817d.js"><link rel="prefetch" href="/myBlog/assets/js/23.60e63597.js"><link rel="prefetch" href="/myBlog/assets/js/24.92d1c8c2.js"><link rel="prefetch" href="/myBlog/assets/js/25.5c97587c.js"><link rel="prefetch" href="/myBlog/assets/js/26.51bb9e96.js"><link rel="prefetch" href="/myBlog/assets/js/27.de9bf61e.js"><link rel="prefetch" href="/myBlog/assets/js/28.9259c37b.js"><link rel="prefetch" href="/myBlog/assets/js/3.786eb002.js"><link rel="prefetch" href="/myBlog/assets/js/30.2f3a30e2.js"><link rel="prefetch" href="/myBlog/assets/js/31.7f777d0d.js"><link rel="prefetch" href="/myBlog/assets/js/32.a36928db.js"><link rel="prefetch" href="/myBlog/assets/js/33.aa38dedd.js"><link rel="prefetch" href="/myBlog/assets/js/34.c7a8a11d.js"><link rel="prefetch" href="/myBlog/assets/js/35.a20950e7.js"><link rel="prefetch" href="/myBlog/assets/js/36.37087d81.js"><link rel="prefetch" href="/myBlog/assets/js/37.98114411.js"><link rel="prefetch" href="/myBlog/assets/js/38.49c70672.js"><link rel="prefetch" href="/myBlog/assets/js/39.80d27f8a.js"><link rel="prefetch" href="/myBlog/assets/js/4.19ec4e6b.js"><link rel="prefetch" href="/myBlog/assets/js/40.c750c79e.js"><link rel="prefetch" href="/myBlog/assets/js/41.5f89e6ff.js"><link rel="prefetch" href="/myBlog/assets/js/42.1a2f2bc2.js"><link rel="prefetch" href="/myBlog/assets/js/43.d00efe51.js"><link rel="prefetch" href="/myBlog/assets/js/44.b31594b1.js"><link rel="prefetch" href="/myBlog/assets/js/45.dac01624.js"><link rel="prefetch" href="/myBlog/assets/js/46.c2c39aee.js"><link rel="prefetch" href="/myBlog/assets/js/5.b6407363.js"><link rel="prefetch" href="/myBlog/assets/js/6.21c1d912.js"><link rel="prefetch" href="/myBlog/assets/js/7.19df07dc.js"><link rel="prefetch" href="/myBlog/assets/js/8.1326d1c7.js"><link rel="prefetch" href="/myBlog/assets/js/9.ce4c0316.js">
    <link rel="stylesheet" href="/myBlog/assets/css/0.styles.cc54622c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myBlog/" class="home-link router-link-active"><!----> <span class="site-name">will个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学无止境" class="dropdown-title"><span class="title">学无止境</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myBlog/keeplearning/JavaScript/" class="nav-link router-link-active">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/myBlog/keeplearning/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/myBlog/keeplearning/react/" class="nav-link">
  React
</a></li></ul></div></div><div class="nav-item"><a href="/myBlog/interview/" class="nav-link">
  面试指导
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="书籍" class="dropdown-title"><span class="title">书籍</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          JavaScript书籍
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/myBlog/books/JavaScript/你不知道的javascript上.html" class="nav-link">
  你不知道的javascript上
</a></li><li class="dropdown-subitem"><a href="/myBlog/books/JavaScript/你不知道的javascript中.html" class="nav-link">
  你不知道的javascript中
</a></li><li class="dropdown-subitem"><a href="/myBlog/books/JavaScript/你不知道的javascript下.html" class="nav-link">
  你不知道的javascript下
</a></li></ul></li><li class="dropdown-item"><h4>
          git书籍
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/myBlog/books/git/目录.html" class="nav-link">
  精通git
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏夹" class="dropdown-title"><span class="title">收藏夹</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myBlog/favorites/tool/" class="nav-link">
  开发工具
</a></li><li class="dropdown-item"><!----> <a href="/myBlog/favorites/website/" class="nav-link">
  网址收藏
</a></li><li class="dropdown-item"><!----> <a href="/myBlog/favorites/share/" class="nav-link">
  精品分享
</a></li></ul></div></div><div class="nav-item"><a href="/myBlog/problem/" class="nav-link">
  问题集锦
</a></div><div class="nav-item"><a href="/myBlog/common/" class="nav-link">
  基础配置功能
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学无止境" class="dropdown-title"><span class="title">学无止境</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myBlog/keeplearning/JavaScript/" class="nav-link router-link-active">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/myBlog/keeplearning/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/myBlog/keeplearning/react/" class="nav-link">
  React
</a></li></ul></div></div><div class="nav-item"><a href="/myBlog/interview/" class="nav-link">
  面试指导
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="书籍" class="dropdown-title"><span class="title">书籍</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          JavaScript书籍
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/myBlog/books/JavaScript/你不知道的javascript上.html" class="nav-link">
  你不知道的javascript上
</a></li><li class="dropdown-subitem"><a href="/myBlog/books/JavaScript/你不知道的javascript中.html" class="nav-link">
  你不知道的javascript中
</a></li><li class="dropdown-subitem"><a href="/myBlog/books/JavaScript/你不知道的javascript下.html" class="nav-link">
  你不知道的javascript下
</a></li></ul></li><li class="dropdown-item"><h4>
          git书籍
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/myBlog/books/git/目录.html" class="nav-link">
  精通git
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏夹" class="dropdown-title"><span class="title">收藏夹</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myBlog/favorites/tool/" class="nav-link">
  开发工具
</a></li><li class="dropdown-item"><!----> <a href="/myBlog/favorites/website/" class="nav-link">
  网址收藏
</a></li><li class="dropdown-item"><!----> <a href="/myBlog/favorites/share/" class="nav-link">
  精品分享
</a></li></ul></div></div><div class="nav-item"><a href="/myBlog/problem/" class="nav-link">
  问题集锦
</a></div><div class="nav-item"><a href="/myBlog/common/" class="nav-link">
  基础配置功能
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JavaScript异步编程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/myBlog/keeplearning/JavaScript/js-异步编程.html" class="active sidebar-link">JavaScript异步编程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myBlog/keeplearning/JavaScript/js-异步编程.html#单线程" class="sidebar-link">单线程</a></li><li class="sidebar-sub-header"><a href="/myBlog/keeplearning/JavaScript/js-异步编程.html#同步和异步" class="sidebar-link">同步和异步</a></li><li class="sidebar-sub-header"><a href="/myBlog/keeplearning/JavaScript/js-异步编程.html#消息队列和事件循环" class="sidebar-link">消息队列和事件循环</a></li><li class="sidebar-sub-header"><a href="/myBlog/keeplearning/JavaScript/js-异步编程.html#js的异步发展史" class="sidebar-link">JS的异步发展史</a></li><li class="sidebar-sub-header"><a href="/myBlog/keeplearning/JavaScript/js-异步编程.html#回调函数" class="sidebar-link">回调函数</a></li><li class="sidebar-sub-header"><a href="/myBlog/keeplearning/JavaScript/js-异步编程.html#promise" class="sidebar-link">Promise</a></li><li class="sidebar-sub-header"><a href="/myBlog/keeplearning/JavaScript/js-异步编程.html#async与await" class="sidebar-link">async与await</a></li><li class="sidebar-sub-header"><a href="/myBlog/keeplearning/JavaScript/js-异步编程.html#async-await不使用try-catch" class="sidebar-link">async..await不使用try..catch</a></li><li class="sidebar-sub-header"><a href="/myBlog/keeplearning/JavaScript/js-异步编程.html#理解async-await的实现原理" class="sidebar-link">理解async..await的实现原理</a></li></ul></li><li><a href="/myBlog/keeplearning/JavaScript/js-解析call-apply-bind.html" class="sidebar-link">JavaScript解析-call、apply 和 bind</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript经典问题</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="javascript异步编程"><a href="#javascript异步编程" class="header-anchor">#</a> JavaScript异步编程</h1> <h2 id="单线程"><a href="#单线程" class="header-anchor">#</a> 单线程</h2> <p>单线程是指在<strong>JS引擎中负责解析和执行JavaScript代码的线程只有一个</strong>，不妨叫它主线程。<br>
所谓单线程，就是指一次只能完成一件任务。如有多个任务，就必须排队，前面一个任务在执行后面的一个任务。<br></p> <p>这种模式的好处是实现起来比较简单，执行环境相对单纯；坏处是只要有一个任务耗时很长，后面的任务都必须排队等着，会拖延整个程序的执行。常见的浏览器无响应（假死），往往就是因为某一段JavaScript代码长时间运行（比如死循环），导致整个页面卡在这个地方，其他任务无法执行。<br></p> <p>但实际上还存在其他线程，例如：处理<code>ajax</code>请求的线程，处理<code>DOM</code>事件的线程，定时器线程，读写文件的线程<code>(Node.js)</code>等等。这些线程可能存在于<code>JS</code>引擎之内，也可能存在于<code>JS</code>引擎之外，统称<strong>工作线程</strong>。</p> <h2 id="同步和异步"><a href="#同步和异步" class="header-anchor">#</a> 同步和异步</h2> <p>虽然JavaScript语言是“单线程”执行环境，但在执行模式下，分为同步和异步两种模式，其中我们更多的使用回调函数的方式来进行异步操作</p> <ul><li>同步模式：任务安排列顺序执行</li> <li>异步模式：其实就是延迟处理。异步是通过异步函数实现的。如：setTimeout().</li></ul> <p>异步过程：主线程发起一个异步请求，相应的工作线程接受请求并告知主线程已经收到（异步函数返回）；主线程可以继续执行后面的代码。同时主线程执行异步任务；工作线程完成工作后，通知主线程；主线程收到通知后，执行一定的动作（调用回调函数）。</p> <p>异步操作的应用场景</p> <ul><li>定时器setTimeout() 与 setInterval()</li> <li>生成器：generator</li> <li>请求: XMLHTTPRequest 与 Fetch</li></ul> <p><strong>举例</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> start <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> current <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> dvalue <span class="token operator">=</span> current <span class="token operator">-</span> start<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dvalue <span class="token operator">+</span> <span class="token string">'ms'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span> <span class="token operator">-</span> start <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>因为<code>setTimeout</code>和<code>setInterval</code>的计时精度问题，不同的浏览器得到的数值可能稍微有出入。但是这个数值肯定大于等于1000ms.<br></p> <p>在这个例子里，js按顺序往下执行时，遇到setTimeout()函数，setTimeOut()函数直接返回，里面的回调函数被放入到<strong>事件队列</strong>里。js接着往下执行while循环，当时间差 <code>&gt;= 1000</code>时，跳出循环，执行完毕。此时js才会去处理队列里的事件。</p> <h2 id="消息队列和事件循环"><a href="#消息队列和事件循环" class="header-anchor">#</a> 消息队列和事件循环</h2> <p>异步过程中，工作线程在异步操作完成后需要通知主线程。那么这个通知机制是怎样实现的呢？ 是利用消息队列和事件循环。<br></p> <p>工作线程将消息放到消息队列，主线程通过事件循环过程去取消息<br></p> <ul><li>消息队列：消息队列是一个先进先出的队列，它里面存放着各种消息。</li> <li>事件循环：事件循环是指主线程重复从消息队列中取消息，执行的过程。</li></ul> <p>实际上，主线程只会做一件事情，就是从消息队列里面取消息、执行消息、再取消息、再执行。当消息队列为空时，就回等待直到消息队列变成非空。而且主线程只有在将当前的消息执行完成后，才会去取下一个消息。这种机制就叫做事件循环机制，取一个消息的并执行的过程叫做一次循环。</p> <h2 id="js的异步发展史"><a href="#js的异步发展史" class="header-anchor">#</a> JS的异步发展史</h2> <ul><li>回调函数</li> <li>Promise</li> <li>生成器与迭代器</li> <li>async/await</li></ul> <p>简单归纳就是：<code>JS天生异步</code></p> <h2 id="回调函数"><a href="#回调函数" class="header-anchor">#</a> 回调函数</h2> <p>回调函数将一个函数以参数的形似传递到另一个函数, 控制其执行的时机, 以达到异步的效果<br></p> <p>在Node.js读写文件的时候经常用到：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'config.json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>又比如，jquery的ajax就是一个典型的异步回调方法:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>$<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  url<span class="token operator">:</span> <span class="token string">'./index.php'</span><span class="token punctuation">,</span>
  contentType<span class="token operator">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'quanzaiyu'</span><span class="token punctuation">,</span>
    password<span class="token operator">:</span> <span class="token number">123</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">complete</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>但是如果在请求的时候, 一个接口依赖于另一个接口的返回值, 将会类似于如下嵌套:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>$<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'url1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        $<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'url2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>“回调函数，内嵌回调函数” 可以无穷尽的内嵌，结果就是各个部分之间高度耦合，流程混在一起，每个任务只能指定一个回调函数。最终造成的结果就会嵌入回调地狱，很可能就像这样了——结尾是无止境的, 也可能造成不可预估的结果</p></div> <h2 id="promise"><a href="#promise" class="header-anchor">#</a> Promise</h2> <p>所谓 Promise, 就是一个对象,用来传递异步操作的消息。它代表了某个未来才会知道结果的事件 (通常是一个异步操作)，并且这个事件提供统一的 API，可供进一步处理。</p> <p>Promise要解决的就是回调函数回调地狱的问题, 通过更直观的方式避免错误的产生,Promise 对象有以下两个特点:</p> <ul><li>（1）对象的状态不受外界影响。Promise 对象代表一个异步操作，有三种状态：Pending（进行中）、Resolved（已完成，又称 Fulfilled）和 Rejected（已失败）。只有异步操作的结果，可以决定当前是哪一种状态，任何其他操作都无法改变这个状态。这也是 Promise 这个名字的由来，它的英语意思就是「承诺」，表示其他手段无法改变。</li> <li>一旦状态改变，就不会再变，任何时候都可以得到这个结果。Promise 对象的状态改变，只有两种可能：从 Pending 变为 Resolved 和从 Pending 变为 Rejected。只要这两种情况发生，状态就凝固了，不会再变了，会一直保持这个结果。就算改变已经发生了，你再对 Promise 对象添加回调函数，也会立即得到这个结果。这与事件（Event）完全不同，事件的特点是，如果你错过了它，再去监听，是得不到结果的。
<strong>一个简单的Promise使用方式:</strong></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="几种状态"><a href="#几种状态" class="header-anchor">#</a> 几种状态</h3> <ul><li>onFulfilled 执行状态，resolve()被调用</li> <li>onRejected 拒绝状态，reject()被调用</li> <li>pending 等待状态（进行中）</li></ul> <h3 id="创建promise"><a href="#创建promise" class="header-anchor">#</a> 创建Promise</h3> <p><strong>方式一：直接 new Promise</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">asyncFun</span> <span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'yes'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'no'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>方式二：使用快捷方式创建</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">asyncFun</span> <span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'yes'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'no'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="调用方式"><a href="#调用方式" class="header-anchor">#</a> 调用方式</h3> <p>方式一：普通调用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">asyncFun</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>方式二：async..await</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">asyncFun</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="从回调函数向promise转换"><a href="#从回调函数向promise转换" class="header-anchor">#</a> 从回调函数向Promise转换</h3> <p>一个普通的回调函数可以封装成Promise, 比如:<br></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">promiseAjax</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      url<span class="token punctuation">,</span>
      data<span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">promiseAjax</span><span class="token punctuation">(</span><span class="token string">'http://test.com'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span> <span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="async与await"><a href="#async与await" class="header-anchor">#</a> async与await</h2> <p>Async/Await是一个很久就令人期待的 JavaScript 功能，它让使用异步函数更加愉快和容易理解。它是基于 Promise 的并且和现存的所有基于 Promise 的 API 相兼容。 Async/Await 版本的代码更短并且可读性更强, 使得异步方法形同同步方法一样地使用，作为Promise的语法糖非常甜！<br></p> <p><strong>从Promise转换为async..await</strong>
只要返回的是一个 Promise 对象, 都可以使用async...await的调用方式, 比如刚才的 promiseAjax 方法:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testAjax</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">promiseAjax</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>看上去是同步的代码，实际执行是异步的<br>
注意, 在使用时需要进行 try..catch, 以免产生错误</p></div> <h2 id="async-await不使用try-catch"><a href="#async-await不使用try-catch" class="header-anchor">#</a> async..await不使用try..catch</h2> <p>在使用 async..await 的时候，通常需要一堆的 try..catch，虽然摆脱了回调地狱以及 then 嵌套的噩梦，但是又引入了新的问题，过多的 try..catch 破坏了代码结构...</p> <p>为了解决这个问题，我参考了网上一个比较不错的解决方案：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">to</span><span class="token punctuation">(</span><span class="token parameter">promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> promise
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">null</span><span class="token punctuation">,</span> data<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>err<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在使用的时候，只需要判断数组的第一项即可，比如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span>err<span class="token punctuation">,</span> code<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">to</span><span class="token punctuation">(</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://test.com/api/code'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  Toast<span class="token punctuation">.</span><span class="token function">showText</span><span class="token punctuation">(</span><span class="token string">'获取验证码成功：'</span> <span class="token operator">+</span> code<span class="token punctuation">,</span> <span class="token punctuation">{</span>duration<span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>我们看看在使用这种方法之前的写法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://test.com/api/code'</span><span class="token punctuation">)</span>
    Toast<span class="token punctuation">.</span><span class="token function">showText</span><span class="token punctuation">(</span><span class="token string">'获取验证码成功：'</span> <span class="token operator">+</span> code<span class="token punctuation">,</span> <span class="token punctuation">{</span>duration<span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>的确，简洁很多！</p> <h2 id="理解async-await的实现原理"><a href="#理解async-await的实现原理" class="header-anchor">#</a> 理解async..await的实现原理</h2> <p>sync..await 作为 Promise 的语法糖，只能用一个字形容：甜！<br></p> <p>还是先创建一个返回 Promise 的函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">asyncFun</span> <span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'yes'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'no'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="容器"><a href="#容器" class="header-anchor">#</a> 容器</h3> <p>但是假如有这样一个容器，它能如期的执行我们上面的这段代码，我们只需要把代码丢进这个特殊的容器里。<br></p> <p>创建一个生成器容器：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 运行生成器函数的一个容器</span>
<span class="token comment">// 参数必须是一个生成器</span>
<span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">gen</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建迭代器</span>
    <span class="token keyword">const</span> task <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 开始执行</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 用Promise处理</span>
            <span class="token comment">// 解释：无论result.value本身是不是promise对象，都会作为一个promise对象来异步处理</span>
            <span class="token keyword">const</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 把本次执行的结果返回</span>
                <span class="token comment">// 也就是语句 const value = yield func(); 的返回值</span>
                result <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 继续</span>
                <span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 继续</span>
                <span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>现在，我们有了这样的一个容器run，把那段“同步”代码丢进这个容器里：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">asyncFun</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>完美，我们只是在刚才那段“同步”代码前加了一个 yield，即达到了效果！<br></p> <p>转过头，我们再看看我们的async...await：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">asyncFun</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>可以看出，只是将 *变成了async，yield 换成了 await，还省去了“容器”！</p> <h3 id="同步书写，异步执行"><a href="#同步书写，异步执行" class="header-anchor">#</a> 同步书写，异步执行</h3> <p>虽然我们是以同步的方式书写的代码，但从第一个 yield或await的位置开始，后续的代码其实都是异步执行的，举个例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'开始执行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">asyncFun</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'结束了！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>结果是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>开始执行
结束了！
true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">4/13/2020, 6:29:46 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/myBlog/keeplearning/JavaScript/js-解析call-apply-bind.html">
        JavaScript解析-call、apply 和 bind
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/myBlog/assets/js/app.daefb15c.js" defer></script><script src="/myBlog/assets/js/2.97733961.js" defer></script><script src="/myBlog/assets/js/29.8556412b.js" defer></script>
  </body>
</html>
